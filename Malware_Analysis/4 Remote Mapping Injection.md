
# Summary

The process of remote mapping injection involves several key steps:

1. **CreateFileMapping**: This function is used to create a file mapping object.
2. **MapViewOfFile**: Following the creation of the file mapping object, this function is called to map the file mapping object into the local process address space.
3. **Payload Transfer**: The payload is then transferred to the locally allocated memory.
4. **MapViewOfFile2**: A new view of the file is mapped into the remote address space of the target process using MapViewOfFile2. This action maps the local view of the file into the remote process, effectively injecting our copied payload.

# Binary Ninja Analysis

## Main Function Part 1

The main function simply asks an user to supply a parameter upon execution. If the user didn't provide an argument, the program will show the user how to use it and then it will exit the program.

![[Pasted image 20240504145847.png]]
When the user has provided an argument upon execution, it will call an other subroutine located at: `140001325` named; `GetRemoteProcessHandle`.

![[Pasted image 20240504150039.png]]
## GetRemoteProcessHandle Subroutine

The first part of the subroutine, creates a snapshot of the currently running processes on the system and saves this HANDLE in `rax` register.

![[Pasted image 20240504164951.png]]
When the handle is valid, it will continue with this execution flow. Next the subroutine will retrieve information about the first process it finds in the just created HANDLE.

![[Pasted image 20240504165519.png]]

Next part of the subroutine, it will check if the length of the provided string is <= 520 bytes.
![[Pasted image 20240504182447.png]]

Next instruction, it will check if length ``!= 0``, after that it will move the length of the string into a different variable and assign it to a different variable.

![[Pasted image 20240504182928.png]]
Next, we are heading into a `do-while loop`. This loop is meant to convert the user provided argument (process name) into a lowercase string, so later on in this subroutine is able to do a comparison check.

![[Pasted image 20240504183953.png]]


1. A loop iterates through each character of a string stored in memory:
- Characters are converted to lowercase.
- Lowercase characters are stored back in memory.
- Loop continues until all characters are processed
2. The length of the lowercase string is calculated:
- If the resulting length is greater than or equal to 1040 bytes, a range check failure is reported.
3. A null terminator ('\0') is added to the end of the string.

![[Pasted image 20240504191220.png]]
1. Another loop iterates through memory locations, possibly retrieving process-related information:
- Process information is retrieved and compared.
- If the retrieved information indicates no more processes or a condition is met, the loop breaks.
2. Another loop iterates through process information:
- Process information is retrieved and stored in a structure.
-  The loop continues until no more processes are found.

![[Pasted image 20240504191238.png]]

After the subroutine is done, it will close its handle and perform a cleanup.

![[Pasted image 20240504191734.png]]
## Main Subroutine Part 2

Once `hGetRemoteProcessHandle` handle is retrieved, the subroutine is going to check if the handle is valid at memory address: `14000132c`. When the handle is valid, it will continue to create a file mapping object for which is for the payload.

![[Pasted image 20240505121127.png]]

After a file mapping object is created, it will map it in memory with only `WRITE` permissions. 
![[Pasted image 20240505122010.png]]

Next, it will deference pPayload pointer, this enables the program to access the value at that memory address. (Memory address: `1400013da`), it will copy the payload (bytes) to MappedPayload (See source code at the end of this post).

![[Pasted image 20240505122603.png]]

Since it's now only locally mapped (local mapping injection), this specimen focus on remote mapping injection where `MapViewOfFileNuma2` plays here a crucial role since here we specify an address of a remote process.

![[Pasted image 20240505130004.png]]
after the payload is mapped into remote process, we have to create a remote thread in order to execute our payload.

![[Pasted image 20240505130613.png]]
After this, the program will perform a clean up.